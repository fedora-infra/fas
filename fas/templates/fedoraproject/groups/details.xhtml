<%inherit file="/site.xhtml" />

  <%
    user_is_group_admin = request.authenticated_is_group_admin(group.name)
    user_is_sponsor = request.authenticated_is_group_sponsor(group.name)
    user_is_group_manager = request.authenticated_is_admin \
                            or request.authenticated_is_modo() \
                            or user_is_group_admin
  %>

  <%namespace name="paging" file="/paging.xhtml"/>

  %if group.license_sign_up > 0:
  <%namespace name="licenseAgreement" file="/admin/license-agreement.xhtml"/>
    ${licenseAgreement.form(license=group.license, person=request.get_user)}
  %endif

  <div class="page-title">
    <img class="group" src="${request.static_url('fas:static/theme/fedoraproject/logo.png')}"/>
    <h1>${group.display_name or group.name}</h1>
    <p>
      %if group.display_name:
        ${group.name}
      %endif
    </p>
    %if group.parent_group_id > -1:
        <div>
          ${_(u'This group belong to')}
          <a href="${request.route_url('group-details', id=group.parent_group_id)}">
            ${parent_group.name}
          </a>
        </div>
    %endif
    %if request.authenticated_userid:
      %if user_is_group_manager or request.authenticated_is_group_editor():
          <button class="btn btn-default" type="button">
            <a href="${request.route_url('group-edit', id=group.id)}">
              ${_(u'Edit')}
            </a>
          </button>
      %endif
    %endif
  </div>
  %if group.description:
  <div>
    <p>${group.description}</p>
  </div>
  %endif

  <div class=row>
    <div class="col-sm-6 col-md-4">
      <h3></h3>
      <dl class="dl-horizontal">
           %if group.web_link:
             <dt>${_(u'Web page')}</dt>
             <dd>${group.web_link}</dd>
           %endif
           <dt>${_(u'Group type')}</dt>
           <dd>
           %if group.group_types:
             ${group.group_types.name}
           %else:
             -
           %endif
           </dd>
           <dt>${_(u'Principal Administrator')}</dt>
           <dd>
             <a href="${request.route_url('people-profile', id=group.owner_id)}"
                 data-toggle="tooltip" data-placement="top" title="${_(u'View profile')}">
               ${group.owner.username}
             </a>
           </dd>
      </dl>
    </div>
  </div>
  <div class=row>
    <div class="col-sm-6 col-md-4">
      <h3>${_(u'Contact information')}</h3>
      %if not group.mailing_list and not group.irc_channel:
        <div>
          <p>${_(u'No contact informations provided.')}</p>
        </div>
      %else:
        <dl class="dl-horizontal">
             <dt>${_(u'Mailing list')}</dt>
             <dd>
               <a href="mailto:${group.mailing_list}">${group.mailing_list}</a>
               %if group.mailing_list_url:
                 <a href="${group.mailing_list_url}">(${_(u'view list infos')})</a>
               %endif
             </dd>
             <dt>${_(u'IRC channel')}</dt>
             <dd>
               #${group.irc_channel}
               <a href="irc://${group.irc_network}">
                 (${group.irc_network})
               </a>
             </dd>
             <dt>${_(u'')}</dt>
             <dd></dd>
        </dl>
      %endif
    </div>
  </div>
  <div class=row>
    <div class="col-sm-6 col-md-4">
      <h3>${_(u'Membership')}</h3>
      %if not group.need_approval and group.license_sign_up == -1:
        <div>
          <p>${_(u'This group has no special requirements to apply to.')}</p>
          %if request.authenticated_userid and not is_member:
              <dd>
                <form action="${request.route_url('group-apply', id=group.id)}" method="POST">
                <button class="btn btn-default" type="submit">${_(u'Join')}</button>
                </form>
              </dd>
          %endif
        </div>
      %endif
      %if is_member:
          <dl class="dl-horizontal">
            <dt>${_(u'Your role')}</dt><dd>${person_membership.get_role().name.lower()}
            %if group.self_removal:
              <span class="badge">
                <button name="button" data-toggle="modal" data-target="#membershipRemoval">
                 ${_(u'revoke my membership')}
                </button>
              </span>
            %else:
              <span class="badge"><a href="#">(${_(u'request revoking')})</a></span>
            %endif
            </dd>
            %if len(membership_request) > 0:
              %if user_is_group_admin or user_is_sponsor:
                <dt>${_(u'Requests')}<span class="badge">${len(membership_request)}</span></dt>
                  <dd>
                    <a href="#collapseMembershipRequests" data-toggle="collapse">
                      ${_(u'View membership request')}
                    </a>
                  </dd>
              %endif
            %endif
          </dl>
      %else:
        <dl class="dl-horizontal">
          %if group.apply_rules:
            <p>${group.apply_rules}</p>
          %endif
          %if group.need_approval:
            %if request.authenticated_userid and not is_member:
              %if person_membership is not None\
                  and person_membership.get_status() == membership_status.PENDING:
                <dt>${_(u'Status')}</dt>
                  <dd><p>${_(u'Pending...')}</p></dd>
              %else:
<!--
                <form method="POST">
                <button class="btn btn-default" name="data">
                  ${_(u'Apply')}
                </button>
-->
                <form action="${request.route_url('group-apply', id=group.id)}" method="POST">
                <button class="btn btn-default" name="button">
<!--
                    data-toggle="modal" data-target="#groupApplication">
-->
                  ${_(u'Apply')}
                </button>
                </form>
              %endif
            %endif
          %endif
          %if group.license_sign_up > -1:
            <dt>${_(u'This group requires a license agreement')}</dt>
              %if license_signed_up:
                <dd>Signed up</dd> <!-- TODO: Add a nice glyphicon here -->
              %else:
                <dd>
                  <button class="btn btn-default" type="button"
                        data-toggle="modal" data-target="#signLicense">
                    ${_(u'Sign up')}
                  </button>
                </dd>
              %endif
          %endif
        </dl>
      %endif
    </div>
  </div>

  %if len(membership_request) > 0:
    <div class="members-list panel-collapse collapse" id="collapseMembershipRequests">
      <h3>${_(u'Membership Request')}</h3>
      <div class="row">
        %for membership in membership_request:
          <div class="col-sm-6 col-md-4 col-lg-4">
            <ul id="people">
              <li>
                <span>
                  <a href="${request.route_url(
                            'people-profile', id=membership.people.username)}">
                    %if membership.people.avatar:
                      <img src="${membership.people.avatar}?s=50&d=monsterid"
                           class="profile img-circle" />
                    %else:
                      <img src="http://cdn.libravatar.org/avatar/?s=50&d=monsterid"
                           class="img-thumbnail" />
                    %endif
                    ${membership.people.fullname}
                  </a>
                </span>
                <span>
                  %if request.authenticated_userid:
                    %if user_is_group_manager:
                      <form action="${request.route_url('group-action')}"
                        method="POST">
                        <input type="hidden" name="action" value="upgrade">
                        <input type="hidden" name="group_id" value="${group.id}">
                        <input type="hidden" name="user_id" value="${membership.people.id}">
                        <button class="btn btn-default" type="submit">
                          ${_(u'Sponsor')}
                        </button>
                      </form>
                    %endif
                  %endif
                </span>
              </li>
            </ul>
          </div>
        %endfor
      </div>
    </div>
  %endif

  <div class=members-list>
    <h3>${_(u'Members')}</h3>
    %if len(members) > 0:
        <!--
        ${paging.list(name='people', route='group-details', param={'members_page': 2})}
        -->
        <!-- limit members list to 50 for now -->
        <div class="row">
        %for member in members[0:50]:
            <div class="col-sm-6 col-md-4 col-lg-4">
              <ul id="people">
                <li>
                  <span>
                    <a href="${request.route_url('people-profile', id=member.people.id)}">
                      %if member.people.avatar:
                        <img src="${member.people.avatar + '?s=80&d=monsterid'}"
                             class="profile img-circle" />
                      %else:
                        <img src="http://cdn.libravatar.org/avatar/"
                             class="img-thumbnail" />
                      %endif
                    </a>
                  </span>
                  <span>${member.people.fullname}</span>
                  <span>(${_(member.get_role().name.lower())})</span>
                  <span>
                    %if request.authenticated_userid:
                        <% role = member.get_role() %>
                      %if user_is_group_manager:
                        <%namespace name="msLevel" module="fas.models" />
                        %if role < msLevel.module.MembershipRole.ADMINISTRATOR \
                            and user_is_group_admin \
                            or role < msLevel.module.MembershipRole.SPONSOR \
                            and user_is_sponsor:
                          <form action="${request.route_url('group-action')}"
                            method="POST">
                            <input type="hidden" name="action" value="upgrade">
                            <input type="hidden" name="group_id" value="${group.id}">
                            <input type="hidden" name="user_id" value="${member.people.id}">
                            <button class="btn btn-default" type="submit">
                              ${_(u'Upgrade to %s' % member.get_role(role + 1).name.lower())}
                            </button>
                          </form>
                        %endif
                        %if role > msLevel.module.MembershipRole.USER \
                            and user_is_group_admin \
                            or role > msLevel.module.MembershipRole.USER \
                            and role < msLevel.module.MembershipRole.SPONSOR \
                            and user_is_sponsor:
                        <form action="${request.route_url('group-action')}"
                          method="POST">
                          <input type="hidden" name="action" value="downgrade">
                          <input type="hidden" name="group_id" value="${group.id}">
                          <input type="hidden" name="user_id" value="${member.people.id}">
                          <button class="btn btn-default" type="submit">
                            ${_(u'Downgrade to %s' % member.get_role((role - 0x01)).name.lower())}
                          </button>
                        </form>
                        %endif
                        %if user_is_group_admin:
                        <form action="${request.route_url('group-action')}"
                          method="POST">
                          <input type="hidden" name="action" value="revoke">
                          <input type="hidden" name="group_id" value="${group.id}">
                          <input type="hidden" name="user_id" value="${member.people.id}">
                          <button class="btn btn-default" type="submit">
                            ${_(u'Revoke %s' % role.name.lower())}
                          </button>
                        </form>
                        %endif
                      %endif
                    %endif
                  </span>
                </li>
              </ul>
            </div>
        %endfor
        </div>
    %else:
      <div class="no-members">
        <p>${_(u'No members found.')}</p>
      </div>
    %endif
  </div>
  <form class="form-horizontal" role="form" method="POST"
        action="${request.route_url('group-action')}">
    <div class="modal in" id="membershipRemoval" tabindex="-1" role="dialog" aria-labelledby="MembershipRemoval" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">
                Close
              </span>
            </button>
            <h4 class="modal-title" id="UpdateStatus">${_(u'Membership removal')}</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <div class="col-lg-10">
                  <!-- You can use markdown syntaxes here -->
                  <p>
                    ${_(u'Removing yourself from this group will removed your account'
                          'from any related system.'
                          'Are you sure?')}
                  </p>
                </div>
            </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="group_id" value="${group.id}">
            <input type="hidden" name="user_id" value="${person.id}">
            <button type="button" class="btn btn-default" data-dismiss="modal">${_(u'No')}</button>
            <button type="submit" class="btn btn-primary" name="action" value="removal">${_('Yes')}</button>
          </div>
        </div>
      </div>
    </div>
  </form>
